<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pickleball Leaderboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .leaderboard {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .leaderboard-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: grid;
            grid-template-columns: 60px 1fr 120px 120px 120px;
            gap: 15px;
            font-weight: 600;
        }

        .player-row {
            display: grid;
            grid-template-columns: 60px 1fr 120px 120px 120px;
            gap: 15px;
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
            transition: all 0.3s ease;
        }

        .player-row:hover {
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            transform: translateY(-2px);
        }

        .rank {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
        }

        .rank.gold {
            color: #ffd700;
        }

        .rank.silver {
            color: #c0c0c0;
        }

        .rank.bronze {
            color: #cd7f32;
        }

        .player-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
        }

        .rating {
            font-size: 1.3em;
            font-weight: bold;
            color: #27ae60;
            text-align: center;
        }

        .form-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        select,
        input,
        button {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .match-history {
            margin-top: 20px;
        }

        .match-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .match-players {
            font-weight: 600;
            color: #2c3e50;
        }

        .winner {
            color: #27ae60;
        }

        .loser {
            color: #e74c3c;
        }

        .player-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .stat-value {
            font-weight: bold;
            color: #667eea;
        }

        .rating-chart {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #27ae60;
        }

        .player-match-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            padding: 15px;
            background: white;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            align-items: center;
        }

        .player-match-item.win {
            border-left-color: #27ae60;
            background: linear-gradient(90deg, rgba(39, 174, 96, 0.05), white);
        }

        .player-match-item.loss {
            border-left-color: #e74c3c;
            background: linear-gradient(90deg, rgba(231, 76, 60, 0.05), white);
        }

        .match-result {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
        }

        .match-result.win {
            background: #27ae60;
        }

        .match-result.loss {
            background: #e74c3c;
        }

        .rating-change {
            font-weight: bold;
            font-size: 1.1em;
        }

        .rating-change.positive {
            color: #27ae60;
        }


        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
                border-radius: 15px;
            }

            h1 {
                font-size: 2em;
                margin-bottom: 20px;
            }

            .tabs {
                flex-wrap: wrap;
                gap: 5px;
                margin-bottom: 20px;
            }

            .tab {
                padding: 10px 16px;
                font-size: 14px;
                flex: 1;
                min-width: 120px;
                text-align: center;
            }

            .leaderboard-header,
            .player-row {
                grid-template-columns: 50px 1fr 80px;
                gap: 10px;
            }

            .rd,
            .vol {
                display: none;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-section {
                padding: 20px;
            }

            .form-section h2 {
                font-size: 1.5em;
                margin-bottom: 20px;
            }

            /* Mobile-specific match form layout */
            .match-form-mobile {
                display: block !important;
            }

            .match-form-mobile>div {
                margin-bottom: 25px;
            }

            .match-form-mobile h3 {
                font-size: 1.2em;
                margin-bottom: 15px;
            }

            .player-match-item {
                grid-template-columns: 1fr auto;
                gap: 10px;
            }

            .player-match-item>div:first-child {
                min-width: 0;
            }

            .player-match-item>div:first-child>div:first-child {
                font-size: 0.9em;
                line-height: 1.3;
            }

            /* Player profile mobile adjustments */
            .profile-mobile-layout {
                display: block !important;
            }

            .profile-mobile-layout>div {
                margin-bottom: 20px;
            }

            .player-stats {
                padding: 15px;
            }

            .rating-chart {
                padding: 15px;
            }

            #rating-chart {
                width: 100%;
                height: 200px;
            }

            .stat-item {
                padding: 10px 0;
            }

            .stat-label {
                font-size: 0.9em;
            }

            .stat-value {
                font-size: 1em;
            }

            /* Match history mobile */
            .match-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .match-item>div:last-child {
                align-self: flex-end;
            }

            .match-players {
                font-size: 0.9em;
                line-height: 1.4;
            }

            /* Form inputs mobile */
            select,
            input,
            button {
                font-size: 16px;
                /* Prevents zoom on iOS */
            }

            .btn {
                padding: 15px;
                font-size: 16px;
            }

            /* Leaderboard mobile enhancements */
            .player-row {
                padding: 15px;
            }

            .player-name {
                font-size: 1em;
            }

            .rating {
                font-size: 1.1em;
            }

            .rank {
                font-size: 1.2em;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .tab {
                padding: 8px 12px;
                font-size: 13px;
                min-width: 100px;
            }

            .leaderboard-header,
            .player-row {
                grid-template-columns: 40px 1fr 70px;
                gap: 8px;
            }

            .player-row {
                padding: 12px;
            }

            .rank {
                font-size: 1.1em;
            }

            .player-name {
                font-size: 0.9em;
            }

            .rating {
                font-size: 1em;
            }

            .form-section {
                padding: 15px;
            }

            .match-item {
                padding: 10px;
            }

            .player-match-item {
                padding: 10px;
            }

            .btn {
                padding: 12px;
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üèì Pickleball Leaderboard</h1>

        <div class="tabs">
            <button class="tab active" id="leaderboard-tab">Leaderboard</button>
            <button class="tab" id="add-match-tab">Add Match</button>
            <button class="tab" id="add-player-tab">Add Player</button>
            <button class="tab" id="player-profile-tab">Player Profile</button>
            <button class="tab" id="matches-tab">Match History</button>
        </div>

        <div id="leaderboard" class="tab-content active">
            <div class="leaderboard">
                <div class="leaderboard-header">
                    <div>Rank</div>
                    <div>Player</div>
                    <div>Rating</div>
                    <div class="rd">Win/Loss</div>
                    <div class="vol">Winrate</div>
                </div>
                <div id="leaderboard-body"></div>
            </div>
        </div>

        <div id="add-match" class="tab-content">
            <div class="form-section">
                <h2>Add 2v2 Match Result</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3 style="color: #27ae60; margin-bottom: 15px;">üèÜ Winning Team</h3>
                        <div class="form-group">
                            <label for="winner1">Player 1</label>
                            <select id="winner1"></select>
                        </div>
                        <div class="form-group">
                            <label for="winner2">Player 2</label>
                            <select id="winner2"></select>
                        </div>
                    </div>
                    <div>
                        <h3 style="color: #e74c3c; margin-bottom: 15px;">‚ùå Losing Team</h3>
                        <div class="form-group">
                            <label for="loser1">Player 1</label>
                            <select id="loser1"></select>
                        </div>
                        <div class="form-group">
                            <label for="loser2">Player 2</label>
                            <select id="loser2"></select>
                        </div>
                    </div>
                </div>
                <div class="form-grid" style="margin-top: 20px;">
                    <div class="form-group">
                        <label for="winning-score">Winning Team Score</label>
                        <input type="number" id="winning-score" min="11" max="21" value="11">
                    </div>
                    <div class="form-group">
                        <label for="losing-score">Losing Team Score</label>
                        <input type="number" id="losing-score" min="0" max="20" value="9">
                    </div>
                </div>
                <button class="btn" id="addMatch">Add Match</button>
            </div>
        </div>

        <div id="add-player" class="tab-content">
            <div class="form-section">
                <h2>Add New Player</h2>
                <div class="form-group">
                    <label for="player-name">Player Name</label>
                    <input type="text" id="player-name" placeholder="Enter player name">
                </div>
                <button class="btn" id="addPlayer">Add Player</button>
            </div>
        </div>

        <div id="matches" class="tab-content">
            <div class="form-section">
                <h2>Match History</h2>
                <div id="match-history" class="match-history"></div>
            </div>
        </div>

        <div id="player-profile" class="tab-content">
            <div class="form-section">
                <h2>Player Profile</h2>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="profile-player">Select Player</label>
                    <select id="profile-player">
                        <option value="">Choose a player</option>
                    </select>
                </div>
                <div id="player-profile-content" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div class="player-stats">
                            <h3>Player Statistics</h3>
                            <div id="player-stats-content"></div>
                        </div>
                        <div class="rating-chart">
                            <h3>Rating History</h3>
                            <canvas id="rating-chart" width="400" height="250"></canvas>
                        </div>
                    </div>
                    <div class="player-matches">
                        <h3>Match History</h3>
                        <div id="player-match-history"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.0.1/chart.umd.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    </script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { collection, getFirestore, doc, setDoc, addDoc, getDocs } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js'

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD3JXaSvLVnU4QPhWrnxXwXaBdTdescg98",
            authDomain: "watch-pickleball-9b260.firebaseapp.com",
            projectId: "watch-pickleball-9b260",
            storageBucket: "watch-pickleball-9b260.firebasestorage.app",
            messagingSenderId: "508288101353",
            appId: "1:508288101353:web:0097caecb0f56dae393978"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app)
        // GLICKO Rating System Implementation
        class GlickoPlayer {
            constructor(name, rating = 1500, rd = 350, vol = 0.06, matches, ratingHistory, matchHistory, wins, losses) {
                this.name = name;
                this.rating = rating;
                this.rd = rd; // Rating Deviation
                this.vol = vol; // Volatility
                this.matches = matches;
                this.ratingHistory = ratingHistory;
                this.matchHistory = matchHistory;
                this.wins = wins;
                this.losses = losses;
            }

            addMatch(matchData) {
                this.matchHistory.push(matchData);
                const ratingHistoryEntry = {
                    rating: this.rating,
                    rd: this.rd,
                    date: new Date().toLocaleDateString()
                }
                this.ratingHistory.push(ratingHistoryEntry);
                if (matchData.result === 'win') {
                    this.wins++;
                } else {
                    this.losses++;
                }
                setDoc(doc(db, "players", this.name), {
                    name: this.name,
                    rating: this.rating,
                    rd: this.rd,
                    vo: this.vol,
                    matches: this.matches,
                    ratingHistory: this.ratingHistory,
                    matchHistory: this.matchHistory,
                    wins: this.wins,
                    losses: this.losses
                })
            }

            getWinRate() {
                return this.matches === 0 ? 0 : (this.wins / this.matches * 100).toFixed(1);
            }

            getAveragePartner() {
                const partners = {};
                this.matchHistory.forEach(match => {
                    if (match.partner) {
                        partners[match.partner] = (partners[match.partner] || 0) + 1;
                    }
                });

                let mostFrequentPartner = 'None';
                let maxCount = 0;
                for (const [partner, count] of Object.entries(partners)) {
                    if (count > maxCount) {
                        maxCount = count;
                        mostFrequentPartner = partner;
                    }
                }
                return mostFrequentPartner;
            }
        }

        class GlickoSystem {
            constructor() {
                this.tau = 0.5; // System constant
            }

            // Convert rating to Glicko-2 scale
            mu(rating) {
                return (rating - 1500) / 173.7178;
            }

            // Convert RD to Glicko-2 scale
            phi(rd) {
                return rd / 173.7178;
            }

            // Convert back to original scale
            rating(mu) {
                return mu * 173.7178 + 1500;
            }

            rd(phi) {
                return phi * 173.7178;
            }

            // G function
            g(phi) {
                return 1 / Math.sqrt(1 + 3 * phi * phi / (Math.PI * Math.PI));
            }

            // E function (expected score)
            E(mu, mu_j, phi_j) {
                return 1 / (1 + Math.exp(-this.g(phi_j) * (mu - mu_j)));
            }

            // Update ratings after a match (1v1)
            updateRatings(winner, loser) {
                const mu1 = this.mu(winner.rating);
                const mu2 = this.mu(loser.rating);
                const phi1 = this.phi(winner.rd);
                const phi2 = this.phi(loser.rd);

                // Calculate v (estimated variance)
                const g1 = this.g(phi2);
                const g2 = this.g(phi1);
                const E1 = this.E(mu1, mu2, phi2);
                const E2 = this.E(mu2, mu1, phi1);

                const v1 = 1 / (g1 * g1 * E1 * (1 - E1));
                const v2 = 1 / (g2 * g2 * E2 * (1 - E2));

                // Calculate delta
                const delta1 = v1 * g1 * (1 - E1); // Winner gets score 1
                const delta2 = v2 * g2 * (0 - E2);  // Loser gets score 0

                // Update volatility (simplified)
                const a = Math.log(winner.vol * winner.vol);
                const newVol1 = Math.exp(a / 2);
                const newVol2 = Math.exp(Math.log(loser.vol * loser.vol) / 2);

                // Update RD
                const newPhi1 = Math.sqrt(phi1 * phi1 + newVol1 * newVol1);
                const newPhi2 = Math.sqrt(phi2 * phi2 + newVol2 * newVol2);

                // Update rating
                const newPhi1Final = 1 / Math.sqrt(1 / (newPhi1 * newPhi1) + 1 / v1);
                const newPhi2Final = 1 / Math.sqrt(1 / (newPhi2 * newPhi2) + 1 / v2);

                const newMu1 = mu1 + newPhi1Final * newPhi1Final * g1 * (1 - E1);
                const newMu2 = mu2 + newPhi2Final * newPhi2Final * g2 * (0 - E2);

                // Convert back and update players
                winner.rating = this.rating(newMu1);
                winner.rd = this.rd(newPhi1Final);
                winner.vol = Math.min(newVol1, 0.1);
                winner.matches++;

                loser.rating = this.rating(newMu2);
                loser.rd = this.rd(newPhi2Final);
                loser.vol = Math.min(newVol2, 0.1);
                loser.matches++;
            }

            // Update ratings for 2v2 match
            updateTeamRatings(winningTeam, losingTeam) {
                // Calculate average team ratings for expected outcome
                const avgWinnerRating = (winningTeam[0].rating + winningTeam[1].rating) / 2;
                const avgLoserRating = (losingTeam[0].rating + losingTeam[1].rating) / 2;

                // Create temporary players with team averages for calculation
                const tempWinner = {
                    rating: avgWinnerRating,
                    rd: Math.min(winningTeam[0].rd, winningTeam[1].rd),
                    vol: (winningTeam[0].vol + winningTeam[1].vol) / 2
                };
                const tempLoser = {
                    rating: avgLoserRating,
                    rd: Math.min(losingTeam[0].rd, losingTeam[1].rd),
                    vol: (losingTeam[0].vol + losingTeam[1].vol) / 2
                };

                // Calculate expected outcome
                const expectedWin = this.E(this.mu(tempWinner.rating), this.mu(tempLoser.rating), this.phi(tempLoser.rd));

                // Rating change based on score difference and expected outcome
                const baseChange = (1 - expectedWin) * 32;

                // Update each player individually with team-based adjustment
                winningTeam.forEach(player => {
                    const personalExpected = this.E(this.mu(player.rating), this.mu(avgLoserRating), this.phi(tempLoser.rd));
                    const personalChange = baseChange * (1.2 - personalExpected); // Slight personal adjustment

                    player.rating += personalChange;
                    player.rd = Math.max(30, player.rd - 2); // Decrease uncertainty
                    player.vol = Math.max(0.03, player.vol * 0.99);
                    player.matches++;
                });

                losingTeam.forEach(player => {
                    const personalExpected = this.E(this.mu(player.rating), this.mu(avgWinnerRating), this.phi(tempWinner.rd));
                    const personalChange = baseChange * (personalExpected - 0.2); // Negative change for losers

                    player.rating -= Math.abs(personalChange);
                    player.rd = Math.max(30, player.rd - 2);
                    player.vol = Math.max(0.03, player.vol * 0.99);
                    player.matches++;
                });
            }
        }

        // UI Functions
        function showTab(event, tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'leaderboard') {
                updateLeaderboard();
            } else if (tabName === 'add-match') {
                updatePlayerSelects();
            } else if (tabName === 'matches') {
                updateMatchHistory();
            } else if (tabName === 'player-profile') {
                updatePlayerProfileSelect();
            }
        }

        function updateLeaderboard() {
            const sortedPlayers = [...players].sort((a, b) => b.rating - a.rating);
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';

            sortedPlayers.forEach((player, index) => {
                const row = document.createElement('div');
                row.className = 'player-row';

                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';

                row.innerHTML = `
                    <div class="rank ${rankClass}">${index + 1}</div>
                    <div class="player-name">${player.name}</div>
                    <div class="rating">${Math.round(player.rating)}</div>
                    <div class="win-loss">${player.wins}/${player.losses}</div>
                    <div class="win rate">${(player.wins / (player.wins + player.losses)).toFixed(2) * 100}%</div>
                `;
                row.onclick = (event) => {
                    showTab(event, 'player-profile')
                    document.getElementById('profile-player').value = players.indexOf(player)
                    updatePlayerProfile()
                }

                tbody.appendChild(row);
            });
        }

        function updatePlayerProfileSelect() {
            const select = document.getElementById('profile-player');
            select.innerHTML = '<option value="">Choose a player</option>';

            players.forEach((player, index) => {
                select.innerHTML += `<option value="${index}">${player.name}</option>`;
            });
        }

        function updatePlayerProfile() {
            const playerIndex = document.getElementById('profile-player').value;
            const contentDiv = document.getElementById('player-profile-content');

            if (playerIndex === '') {
                contentDiv.style.display = 'none';
                return;
            }

            const player = players[playerIndex];
            contentDiv.style.display = 'block';

            // Update stats
            const statsDiv = document.getElementById('player-stats-content');
            const winRate = player.getWinRate();
            const mostFrequentPartner = player.getAveragePartner();
            const peakRating = Math.max(...player.ratingHistory.map(r => r.rating));
            const ratingChange = player.ratingHistory.length > 1 ?
                player.rating - player.ratingHistory[0].rating : 0;

            statsDiv.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">Current Rating</span>
                    <span class="stat-value">${Math.round(player.rating)}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Peak Rating</span>
                    <span class="stat-value">${Math.round(peakRating)}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Rating Change</span>
                    <span class="stat-value ${ratingChange >= 0 ? 'positive' : 'negative'}">
                        ${ratingChange >= 0 ? '+' : ''}${Math.round(ratingChange)}
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Matches Played</span>
                    <span class="stat-value">${player.matches}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Win Rate</span>
                    <span class="stat-value">${winRate}%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Wins / Losses</span>
                    <span class="stat-value">${player.wins} / ${player.losses}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Most played with</span>
                    <span class="stat-value">${mostFrequentPartner}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Rating Deviation</span>
                    <span class="stat-value">${Math.round(player.rd)}</span>
                </div>
            `;

            // Update rating chart
            drawRatingChart(player);

            // Update match history
            const matchHistoryDiv = document.getElementById('player-match-history');
            matchHistoryDiv.innerHTML = '';

            if (player.matchHistory.length === 0) {
                matchHistoryDiv.innerHTML = '<p>No matches played yet.</p>';
                return;
            }

            player.matchHistory.slice().reverse().forEach(match => {
                const matchDiv = document.createElement('div');
                matchDiv.className = `player-match-item ${match.result}`;

                const ratingChange = match.ratingAfter - match.ratingBefore;

                matchDiv.innerHTML = `
                    <div>
                        <div style="font-weight: 600; margin-bottom: 5px;">
                            vs ${match.opponents} (with ${match.partner})
                        </div>
                        <div style="color: #666; font-size: 0.9em;">${new Date(match.date).toLocaleDateString()}</div>
                    </div>
                    <div class="match-result ${match.result}">
                        ${match.result.toUpperCase()}
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; margin-bottom: 2px;">${match.score}</div>
                        <div class="rating-change ${ratingChange >= 0 ? 'positive' : 'negative'}">
                            ${ratingChange >= 0 ? '+' : ''}${ratingChange}
                        </div>
                    </div>
                `;
                matchHistoryDiv.appendChild(matchDiv);
            });
        }

        function drawRatingChart(player) {
            Chart.getChart("rating-chart")?.destroy()
            new Chart("rating-chart", {
                type: "line",
                data: {
                    labels: player.ratingHistory,
                    datasets: [{
                        data: player.ratingHistory.map(history => history.rating),
                        borderColor: "red",
                        fill: false
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function updatePlayerSelects() {
            const selects = ['winner1', 'winner2', 'loser1', 'loser2'];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select Player</option>';

                players.forEach((player, index) => {
                    select.innerHTML += `<option value="${index}">${player.name}</option>`;
                });
            });
        }

        function addMatch() {
            const winner1Index = document.getElementById('winner1').value;
            const winner2Index = document.getElementById('winner2').value;
            const loser1Index = document.getElementById('loser1').value;
            const loser2Index = document.getElementById('loser2').value;
            const winningScore = parseInt(document.getElementById('winning-score').value);
            const losingScore = parseInt(document.getElementById('losing-score').value);

            // Validation
            if (!winner1Index || !winner2Index || !loser1Index || !loser2Index) {
                alert('Please select all 4 players');
                return;
            }

            const selectedPlayers = [winner1Index, winner2Index, loser1Index, loser2Index];
            if (new Set(selectedPlayers).size !== 4) {
                alert('Please select 4 different players');
                return;
            }

            if (winningScore < 11 || losingScore < 0 || winningScore <= losingScore) {
                alert('Invalid scores. Winning score must be at least 11 and higher than losing score.');
                return;
            }

            // Get player objects
            const winningTeam = [players[winner1Index], players[winner2Index]];
            const losingTeam = [players[loser1Index], players[loser2Index]];
            addMatch2(winningTeam, losingTeam, winningScore, losingScore)
        }

        function addMatch2(winningTeam, losingTeam, winningScore, losingScore) {
            // Update ratings
            glicko.updateTeamRatings(winningTeam, losingTeam);

            const matchDate = new Date().getTime();

            const match = {
                winningTeam: `${winningTeam[0].name} & ${winningTeam[1].name}`,
                losingTeam: `${losingTeam[0].name} & ${losingTeam[1].name}`,
                score: `${winningScore}-${losingScore}`,
                date: matchDate,
                players: {
                    winners: winningTeam.map(p => ({ name: p.name, rating: Math.round(p.rating) })),
                    losers: losingTeam.map(p => ({ name: p.name, rating: Math.round(p.rating) }))
                }
            };

            // Record match
            matches.unshift(match);
            addDoc(collection(db, "matches"), match)

            // Add match to individual player histories

            // Winners
            winningTeam[0].addMatch({
                result: 'win',
                partner: winningTeam[1].name,
                opponents: `${losingTeam[0].name} & ${losingTeam[1].name}`,
                score: `${winningScore}-${losingScore}`,
                date: matchDate,
                ratingBefore: Math.round(winningTeam[0].ratingHistory.at(-1) != null ? winningTeam[0].ratingHistory.at(-1).rating : 1500),
                ratingAfter: Math.round(winningTeam[0].rating)
            });

            winningTeam[1].addMatch({
                result: 'win',
                partner: winningTeam[0].name,
                opponents: `${losingTeam[0].name} & ${losingTeam[1].name}`,
                score: `${winningScore}-${losingScore}`,
                date: matchDate,
                ratingBefore: Math.round(winningTeam[1].ratingHistory.at(-1) != null ? winningTeam[1].ratingHistory.at(-1).rating : 1500),
                ratingAfter: Math.round(winningTeam[1].rating)
            });

            // Losers
            losingTeam[0].addMatch({
                result: 'loss',
                partner: losingTeam[1].name,
                opponents: `${winningTeam[0].name} & ${winningTeam[1].name}`,
                score: `${winningScore}-${losingScore}`,
                date: matchDate,
                ratingBefore: Math.round(losingTeam[0].ratingHistory.at(-1) != null ? losingTeam[0].ratingHistory.at(-1).rating : 1500),
                ratingAfter: Math.round(losingTeam[0].rating)
            });

            losingTeam[1].addMatch({
                result: 'loss',
                partner: losingTeam[0].name,
                opponents: `${winningTeam[0].name} & ${winningTeam[1].name}`,
                score: `${winningScore}-${losingScore}`,
                date: matchDate,
                ratingBefore: Math.round(losingTeam[1].ratingHistory.at(-1) != null ? losingTeam[1].ratingHistory.at(-1).rating : 1500),
                ratingAfter: Math.round(losingTeam[1].rating)
            });

            // Clear form
            ['winner1', 'winner2', 'loser1', 'loser2'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('winning-score').value = '11';
            document.getElementById('losing-score').value = '9';

        }

        function addPlayer() {
            const name = document.getElementById('player-name').value.trim();

            if (!name) {
                alert('Please enter a player name');
                return;
            }

            if (players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                alert('Player already exists');
                return;
            }

            players.push(new GlickoPlayer(name, 1500, 350, 0.06, 0, [{ rating: 1500, rd: 350, date: new Date().toLocaleDateString() }], [], 0, 0));
            document.getElementById('player-name').value = '';
            alert('Player added successfully!');
        }

        function updateMatchHistory() {
            const historyDiv = document.getElementById('match-history');
            historyDiv.innerHTML = '';

            if (matches.length === 0) {
                historyDiv.innerHTML = '<p>No matches recorded yet.</p>';
                return;
            }

            matches.forEach(match => {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'match-item';
                matchDiv.innerHTML = `
                    <div>
                        <div class="match-players">
                            <span class="winner">${match.winningTeam}</span> defeated 
                            <span class="loser">${match.losingTeam}</span>
                        </div>
                        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                            ${match.players.winners.map(p => `${p.name}: ${p.rating}`).join(', ')} | 
                            ${match.players.losers.map(p => `${p.name}: ${p.rating}`).join(', ')}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.2em; font-weight: bold; color: #667eea;">${match.score}</div>
                        <div style="font-size: 0.9em; color: #666;">${new Date(match.date).toLocaleDateString()}</div>
                    </div>
                `;
                historyDiv.appendChild(matchDiv);
            });
        }

        // Application State
        let players = [];
        let matches = [];
        const glicko = new GlickoSystem();
        // Initialize the app

        // Get Players from FireStore
        const playerSnapshot = await getDocs(collection(db, "players"))
        playerSnapshot.forEach(doc => {
            const player = doc.data()
            players.push(new GlickoPlayer(player.name, player.rating, player.rd, player.vol, player.matches, player.ratingHistory, player.matchHistory, player.wins, player.losses))
        })
        const matchesSnapshot = await getDocs(collection(db, "matches"))
        matchesSnapshot.forEach(doc => {
            matches.unshift(doc.data())
        })
        matches.sort((a, b) => a.date > b.date ? -1 : 1)
        document.getElementById("leaderboard-tab").onclick = event => showTab(event, "leaderboard")
        document.getElementById("add-match-tab").onclick = event => showTab(event, "add-match")
        document.getElementById("add-player-tab").onclick = event => showTab(event, "add-player")
        document.getElementById("matches-tab").onclick = event => showTab(event, "matches")
        document.getElementById("player-profile-tab").onclick = event => showTab(event, "player-profile")
        document.getElementById("profile-player").onchange = event => updatePlayerProfile()
        document.getElementById("addMatch").onclick = event => addMatch()
        document.getElementById("addPlayer").onclick = event => addPlayer()

        updateLeaderboard();
    </script>
</body>

</html>